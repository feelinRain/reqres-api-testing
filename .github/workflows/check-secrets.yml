name: Security Check
on: [push, pull_request]

jobs:
  check-secrets:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Check for exposed secrets
        run: |
          echo "üîç Checking for exposed secrets..."
          
          # –ü–∞—Ç—Ç–µ—Ä–Ω—ã —Ä–µ–∞–ª—å–Ω—ã—Ö —Å–µ–∫—Ä–µ—Ç–æ–≤ (–Ω–µ —à–∞–±–ª–æ–Ω–æ–≤)
          REAL_SECRET_PATTERNS=(
            "sk_live_[0-9a-zA-Z]{24}"     # Stripe live key
            "rk_live_[0-9a-zA-Z]{24}"     # Stripe restricted key  
            "AKIA[0-9A-Z]{16}"           # AWS key
            "eyJhbGciOiJ[0-9A-Za-z_-]{10,}"  # JWT token
            "ghp_[0-9a-zA-Z]{36}"        # GitHub token
            "xoxb-[0-9]{11}-[0-9]{11}-[0-9a-zA-Z]{24}" # Slack bot token
          )
          
          FOUND_REAL_SECRET=false
          
          for pattern in "${REAL_SECRET_PATTERNS[@]}"; do
            echo "Checking for: ${pattern:0:20}..."
            if grep -r "$pattern" . --include="*.py" --include="*.json" --include="*.md" 2>/dev/null; then
              echo "‚ùå ERROR: Found real secret pattern: $pattern"
              FOUND_REAL_SECRET=true
            fi
          done
          
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ .env —Ñ–∞–π–ª—ã (–Ω–µ —à–∞–±–ª–æ–Ω—ã)
          if find . -name ".env" -type f ! -name "*.example" ! -name "*.sample" ! -name "*.template"; then
            echo "‚ùå ERROR: Found real .env file (not template)"
            FOUND_REAL_SECRET=true
          fi
          
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ Postman environment —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –∫–ª—é—á–∞–º–∏ (–Ω–µ —à–∞–±–ª–æ–Ω–∞–º–∏)
          if find . -name "*.postman_environment.json" -type f ! -name "*Template*" ! -name "*template*" ! -name "*example*" -exec grep -q "sk_live_\|AKIA\|ghp_" {} \; 2>/dev/null; then
            echo "‚ùå ERROR: Postman environment may contain real keys"
            FOUND_REAL_SECRET=true
          fi
          
          if [ "$FOUND_REAL_SECRET" = true ]; then
            echo "‚ùå FAIL: Potential real secrets found!"
            echo "Please ensure:"
            echo "1. No real API keys in code"
            echo "2. Template files use EXAMPLE values"
            echo "3. Real .env files are in .gitignore"
            exit 1
          else
            echo "‚úÖ PASS: No exposed real secrets found"
            echo "Template files are correctly identified"
          fi
      
      - name: Check template files
        run: |
          echo "üìã Checking template files..."
          
          # Template files should contain example values
          TEMPLATE_FILES=(
            ".env.example"
            "python_tests/.env.example"
            "postman_collection/Environment_Template.json"
          )
          
          for template in "${TEMPLATE_FILES[@]}"; do
            if [ -f "$template" ]; then
              echo "Checking $template..."
              if grep -q "EXAMPLE\|SAMPLE\|TEMPLATE\|CHANGEME\|YOUR_KEY" "$template" || \
                 grep -q "your_.*_here\|paste_.*_here\|add_.*_here" "$template"; then
                echo "  ‚úÖ Contains template values"
              else
                echo "  ‚ö†Ô∏è  May contain real values - please verify"
              fi
            fi
          done
