name: Security Check
on: [push, pull_request]

jobs:
  check-secrets:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Check for REAL secrets (ignore templates)
        run: |
          echo "ðŸ” Checking for REAL secrets (templates allowed)..."
          
          # Ð¡Ð¿Ð¸ÑÐ¾Ðº ÑˆÐ°Ð±Ð»Ð¾Ð½Ð½Ñ‹Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð² ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ Ð˜Ð“ÐÐžÐ Ð˜Ð Ð£Ð•Ðœ
          TEMPLATE_FILES=(
            ".env.example"
            "python_tests/.env.example"
            "postman_collection/Environment_Template.json"
            "postman_collection/Environment_Example.json"
          )
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° 1: Ð ÐµÐ°Ð»ÑŒÐ½Ñ‹Ðµ .env Ñ„Ð°Ð¹Ð»Ñ‹ (Ð½Ðµ ÑˆÐ°Ð±Ð»Ð¾Ð½Ñ‹)
          echo "1. Checking for real .env files..."
          REAL_ENV_FOUND=false
          for env_file in $(find . -name ".env" -type f); do
            IS_TEMPLATE=false
            for template in "${TEMPLATE_FILES[@]}"; do
              if [[ "$env_file" == *"$template"* ]]; then
                IS_TEMPLATE=true
                break
              fi
            done
            
            if [ "$IS_TEMPLATE" = false ]; then
              echo "   âŒ Found REAL .env file: $env_file"
              REAL_ENV_FOUND=true
            else
              echo "   âœ… Template file (ok): $env_file"
            fi
          done
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° 2: Postman environments Ñ Ñ€ÐµÐ°Ð»ÑŒÐ½Ñ‹Ð¼Ð¸ ÐºÐ»ÑŽÑ‡Ð°Ð¼Ð¸
          echo "2. Checking Postman environments..."
          REAL_POSTMAN_FOUND=false
          for postman_file in $(find . -name "*.postman_environment.json" -type f); do
            IS_TEMPLATE=false
            for template in "${TEMPLATE_FILES[@]}"; do
              if [[ "$postman_file" == *"$template"* ]]; then
                IS_TEMPLATE=true
                break
              fi
            done
            
            if [ "$IS_TEMPLATE" = false ]; then
              echo "   âš ï¸  Found non-template Postman file: $postman_file"
              # ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ð¼ ÐµÑÑ‚ÑŒ Ð»Ð¸ Ñ€ÐµÐ°Ð»ÑŒÐ½Ñ‹Ðµ ÐºÐ»ÑŽÑ‡Ð¸
              if grep -q "sk_live_\|AKIA[0-9A-Z]\{16\}\|ghp_" "$postman_file"; then
                echo "   âŒ Contains real key patterns!"
                REAL_POSTMAN_FOUND=true
              fi
            else
              echo "   âœ… Template file (ok): $postman_file"
            fi
          done
          
          # Ð˜Ñ‚Ð¾Ð³
          echo ""
          echo "ðŸ“Š CHECK RESULTS:"
          if [ "$REAL_ENV_FOUND" = true ] || [ "$REAL_POSTMAN_FOUND" = true ]; then
            echo "âŒ FAIL: Found potential security issues"
            echo ""
            echo "ACTION REQUIRED:"
            if [ "$REAL_ENV_FOUND" = true ]; then
              echo "1. Remove real .env files or add to .gitignore"
              echo "   Run: git rm --cached .env"
              echo "   Add to .gitignore: echo '.env' >> .gitignore"
            fi
            if [ "$REAL_POSTMAN_FOUND" = true ]; then
              echo "2. Check Postman environment files for real keys"
              echo "   Only templates should be committed"
            fi
            exit 1
          else
            echo "âœ… PASS: All security checks passed!"
            echo "   - No real .env files found"
            echo "   - Postman files are templates only"
          fi
      
      - name: Final success message
        if: success()
        run: |
          echo "ðŸŽ‰ SECURITY CHECK PASSED!"
          echo "========================="
          echo "Your repository is secure:"
          echo "âœ“ Template files properly committed"
          echo "âœ“ No real secrets exposed"
          echo "âœ“ Ready for portfolio presentation"
