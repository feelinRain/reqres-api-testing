name: Security Check
on: [push, pull_request]

jobs:
  check-secrets:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Check for REAL secrets (ignore templates)
        run: |
          echo " Checking for REAL secrets (templates allowed)..."
          
     
          TEMPLATE_FILES=(
            ".env.example"
            "python_tests/.env.example"
            "postman_collection/Environment_Template.json"
            "postman_collection/Environment_Example.json"
          )
          
         
          echo "1. Checking for real .env files..."
          REAL_ENV_FOUND=false
          for env_file in $(find . -name ".env" -type f); do
            IS_TEMPLATE=false
            for template in "${TEMPLATE_FILES[@]}"; do
              if [[ "$env_file" == *"$template"* ]]; then
                IS_TEMPLATE=true
                break
              fi
            done
            
            if [ "$IS_TEMPLATE" = false ]; then
              echo "    Found REAL .env file: $env_file"
              REAL_ENV_FOUND=true
            else
              echo "    Template file (ok): $env_file"
            fi
          done
          
         
          echo "2. Checking Postman environments..."
          REAL_POSTMAN_FOUND=false
          for postman_file in $(find . -name "*.postman_environment.json" -type f); do
            IS_TEMPLATE=false
            for template in "${TEMPLATE_FILES[@]}"; do
              if [[ "$postman_file" == *"$template"* ]]; then
                IS_TEMPLATE=true
                break
              fi
            done
            
            if [ "$IS_TEMPLATE" = false ]; then
              echo "     Found non-template Postman file: $postman_file"
              # Проверим есть ли реальные ключи
              if grep -q "sk_live_\|AKIA[0-9A-Z]\{16\}\|ghp_" "$postman_file"; then
                echo "    Contains real key patterns!"
                REAL_POSTMAN_FOUND=true
              fi
            else
              echo "    Template file (ok): $postman_file"
            fi
          done
          
          
          echo ""
          echo " CHECK RESULTS:"
          if [ "$REAL_ENV_FOUND" = true ] || [ "$REAL_POSTMAN_FOUND" = true ]; then
            echo " FAIL: Found potential security issues"
            echo ""
            echo "ACTION REQUIRED:"
            if [ "$REAL_ENV_FOUND" = true ]; then
              echo "1. Remove real .env files or add to .gitignore"
              echo "   Run: git rm --cached .env"
              echo "   Add to .gitignore: echo '.env' >> .gitignore"
            fi
            if [ "$REAL_POSTMAN_FOUND" = true ]; then
              echo "2. Check Postman environment files for real keys"
              echo "   Only templates should be committed"
            fi
            exit 1
          else
            echo " PASS: All security checks passed!"
            echo "   - No real .env files found"
            echo "   - Postman files are templates only"
          fi
      
      - name: Final success message
        if: success()
        run: |
          echo " SECURITY CHECK PASSED!"
          echo "========================="
          echo "Your repository is secure:"
          echo "✓ Template files properly committed"
          echo "✓ No real secrets exposed"
          echo "✓ Ready for portfolio presentation"

